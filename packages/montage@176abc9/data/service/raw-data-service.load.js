montageDefine("176abc9","data/service/raw-data-service",{dependencies:["data/service/data-service","frb/compile-evaluator","data/service/data-mapping","data/model/data-identifier","core/serialization/deserializer/montage-deserializer","collections/map","montage","frb/parse","frb/scope","collections/weak-map","core/deprecate","frb/parse","frb/scope","frb/compile-evaluator","core/promise"],factory:function(e,a,t){var r=e("data/service/data-service").DataService,i=(e("frb/compile-evaluator"),e("data/service/data-mapping").DataMapping),n=e("data/model/data-identifier").DataIdentifier,o=e("core/serialization/deserializer/montage-deserializer").MontageDeserializer,s=e("collections/map"),c=e("montage").Montage,p=(e("frb/parse"),e("frb/scope")),u=e("collections/weak-map"),l=e("core/deprecate"),p=(e("frb/parse"),e("frb/scope")),h=(e("frb/compile-evaluator"),e("core/promise").Promise);a.RawDataService=r.specialize({constructor:{value:function(){r.call(this),this._typeIdentifierMap=new s,this._descriptorToRawDataTypeMappings=new s}},initWithModel:{value:function(a){var t=this;return e.async(a).then(function(a){var t=(new o).init(JSON.stringify(a),e);return t.deserializeObject()}).then(function(e){return t.model=e,t})}},deserializeSelf:{value:function(e){this["super"](e);var a=e.getProperty("rawDataTypeMappings");this._registerRawDataTypeMappings(a||[])}},connectionDescriptor:{value:void 0},connection:{value:void 0},_propertyDescriptorForObjectAndName:{value:function(e,a){var t=this.objectDescriptorForObject(e);return t&&t.propertyDescriptorForName(a)}},_objectDescriptorForObject:{value:function(e){var a,t,r,i,n,o=this.types,s=c.getInfoForObject(e),p=s.moduleId,u=s.objectName;for(i=0,n=o.length;i<n&&!r;i+=1)a=o[i].module,t=a&&o[i].exportName,a&&p===a.id&&u===t&&(r=o[i]);return r}},_mapObjectPropertyValue:{value:function(e,a,t){var r=a.name;if(a.cardinality===1/0?this.spliceWithArray(e[r],t):e[r]=t[0],a.inversePropertyName&&t&&t[0]){var i=this._propertyDescriptorForObjectAndName(t[0],a.inversePropertyName);i&&1===i.cardinality&&t.forEach(function(t){t[a.inversePropertyName]=e})}return t}},_objectDescriptorTypeForValueDescriptor:{value:function(e){return e.then(function(e){return e.module.require.async(e.module.id)})}},_fetchRawData:{value:function(e){var a=this,t=this._childServiceForQuery(e.query),i=e.query;t?t._fetchRawData(e):i.authorization?(e.query=a.mapSelectorToRawDataQuery(i),a.fetchRawData(e),e.query=i):this.authorizationPolicy===r.AuthorizationPolicy.NONE?(e.query=a.mapSelectorToRawDataQuery(i),a.fetchRawData(e),e.query=i):r.authorizationManager.authorizeService(this).then(function(e){return a.authorization=e,e})["catch"](function(e){console.log(e)}).then(function(t){e.query=a.mapSelectorToRawDataQuery(i),a.fetchRawData(e),e.query=i})}},fetchRawData:{value:function(e){this.rawDataDone(e)}},cancelRawDataStream:{value:function(e,a){}},deleteDataObject:{value:function(e){var a,t=this,r={},i=this._mapObjectToRawData(e,r);return a=i instanceof h?i.then(function(){return t.deleteRawData(r,e)}):this.deleteRawData(r,e)}},deleteRawData:{value:function(e,a){return this.nullPromise}},saveRawData:{value:function(e,a){return this.nullPromise}},isOffline:{get:function(){return this===this.rootService?this.superForGet("isOffline")():this.rootService.isOffline}},writeOfflineData:{value:function(e,a,t){return this.nullPromise}},addRawData:{value:function(e,a,t){var r,i,n,o=e.query.type;for(r=a&&!this.isOffline&&this._streamRawData.get(e),r?r.push.apply(r,a):a&&!this.isOffline&&this._streamRawData.set(e,a),i=0,n=a&&a.length;i<n;i++)this.addOneRawData(e,a[i],t,o)}},addOneRawData:{value:function(e,a,t){var r=this._descriptorForParentAndRawData(e.query.type,a),i=this.objectForTypeRawData(r,a,t),n=this._mapRawDataToObject(a,i,t);return n&&n instanceof h?n=n.then(function(){return e.addData(i),i}):(e.addData(i),n=h.resolve(i)),this._addMapDataPromiseForStream(n,e),i&&this.callDelegateMethod("rawDataServiceDidAddOneRawData",this,e,a,i),n}},_addMapDataPromiseForStream:{value:function(e,a){this._streamMapDataPromises.has(a)?this._streamMapDataPromises.get(a).push(e):this._streamMapDataPromises.set(a,[e])}},_streamMapDataPromises:{get:function(){return this.__streamMapDataPromises||(this.__streamMapDataPromises=new s),this.__streamMapDataPromises}},objectForTypeRawData:{value:function(e,a,t){var r=this.dataIdentifierForTypeRawData(e,a);return this.recordSnapshot(r,a),this.getDataObject(e,a,t,r)}},_typeIdentifierMap:{value:void 0},dataIdentifierForTypeRawData:{value:function(e,a){var t,r,i,o,c=this.mappingWithType(e),u=c?c.rawDataPrimaryKeyExpressions:null,l=new p(a);if(u&&u.length){i=this._typeIdentifierMap.get(e),i||this._typeIdentifierMap.set(e,i=new s);for(var h,f=0;h=u[f];f++)t=t||[],t[f]=h(l);if(t&&(o=t.join("/"),r=i.get(o)),!r){e.typeName||e.name;r=new n,r.objectDescriptor=e,r.dataService=this,r.typeName=e.name,r._identifier=r.primaryKey=o,i.set(o,r)}return r}}},__snapshot:{value:null},_snapshot:{get:function(){return this.__snapshot||(this.__snapshot=new s)}},recordSnapshot:{value:function(e,a){this._snapshot.set(e,a)}},removeSnapshot:{value:function(e){this._snapshot["delete"](e)}},snapshotForDataIdentifier:{value:function(e){return this._snapshot.get(e)}},snapshotForObject:{value:function(e){return this.snapshotForDataIdentifier(this.dataIdentifierForObject(e))}},rawDataDone:{value:function(e,a){var t=this,r=this._streamRawData.get(e),i=this._streamMapDataPromises.get(e),n=i?h.all(i):this.nullPromise;i&&this._streamMapDataPromises["delete"](e),r&&this._streamRawData["delete"](e),n.then(function(i){return r?t.writeOfflineData(r,e.query,a):null}).then(function(){return e.dataDone(),null})["catch"](function(e){console.error(e)})}},_streamRawData:{get:function(){return this.__streamRawData||(this.__streamRawData=new u),this.__streamRawData}},__streamRawData:{value:void 0},mapSelectorToRawDataQuery:{value:function(e){return e}},mapSelectorToRawDataSelector:{value:l.deprecateMethod(void 0,function(e){return this.mapSelectorToRawDataQuery(e)},"mapSelectorToRawDataSelector","mapSelectorToRawDataQuery")},mappingForObject:{value:function(e){var a=this.objectDescriptorForObject(e),t=a&&this.mappingWithType(a);return!t&&a&&(t=this._objectDescriptorMappings.get(a),t||(t=i.withObjectDescriptor(a),this._objectDescriptorMappings.set(a,t))),t}},mapRawDataToObject:{value:function(e,a,t){return this.mapFromRawData(a,e,t)}},_mapRawDataToObject:{value:function(e,a,t){var r,i=this,n=this.mappingForObject(a);return n?(r=n.mapRawDataToObject(e,a,t),r=r?r.then(function(){return i.mapRawDataToObject(e,a,t)}):this.mapRawDataToObject(e,a,t)):r=this.mapRawDataToObject(e,a,t),r}},mapObjectToRawData:{value:function(e,a,t){}},_mapObjectToRawData:{value:function(e,a,t){var r,i=this.mappingForObject(e);if(i&&(r=i.mapObjectToRawData(e,a,t)),a)if(r){var n=this.mapObjectToRawData(e,a,t);r instanceof h&&n instanceof h?r=h.all([r,n]):n instanceof h&&(r=n)}else r=this.mapObjectToRawData(e,a,t);return r}},_mappingsPromise:{get:function(){return this.__mappingsPromise||(this.__mappingsPromise=h.all(this.mappings.map(function(e){return e.objectDescriptor})).then(function(e){})),this.__mappingsPromise}},_objectDescriptorMappings:{get:function(){return this.__objectDescriptorMappings||(this.__objectDescriptorMappings=new s),this.__objectDescriptorMappings}},_descriptorToRawDataTypeMappings:{value:void 0},_registerRawDataTypeMappings:{value:function(e){var a,t,r,i;for(r=0,i=e?e.length:0;r<i;r++)a=e[r],t=a.type.parent,this._descriptorToRawDataTypeMappings.has(t)||this._descriptorToRawDataTypeMappings.set(t,[]),this._descriptorToRawDataTypeMappings.get(t).push(a)}},_descriptorForParentAndRawData:{value:function(e,a){var t,r,i,n,o=this._descriptorToRawDataTypeMappings.get(e);if(o&&o.length)for(i=0,n=o.length;i<n&&!r;++i)t=o[i],r=t.criteria.evaluate(a)&&t.type;return r?this._descriptorForParentAndRawData(r,a):e}},mapFromRawData:{value:function(e,a,t){}},mapToRawData:{value:function(e,a){}},offlineService:{value:void 0}})}});