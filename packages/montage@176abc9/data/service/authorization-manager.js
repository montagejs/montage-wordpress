var Montage=require("core/core").Montage,Promise=require("core/promise").Promise,Map=require("collections/map"),application=require("core/application").application,AuthorizationPolicy=require("data/service/authorization-policy").AuthorizationPolicy,MANAGER_PANEL_MODULE="ui/authorization-manager-panel.reel",AuthorizationManager=Montage.specialize({constructor:{value:function(){return this._providersByModuleID=new Map,this._panelsByModuleID=new Map,this._authorizationsByProviderModuleID=new Map,this.defineBinding("hasPendingServices",{"<-":"_pendingServicesCount != 0"}),this}},_authorizationsByProviderModuleID:{value:void 0},_panelsByModuleID:{value:void 0},_providersByModuleID:{value:void 0},_managerPanel:{value:function(){var e,r=this;return!this._managerPanelPromise&&this.authorizationManagerPanel?(this.authorizationManagerPanel.authorizationManager=this,this._managerPanelPromise=Promise.resolve(this.authorizationManagerPanel)):this._managerPanelPromise||(e=this.callDelegateMethod("authorizationManagerWillLoadAuthorizationManagerPanel",this,MANAGER_PANEL_MODULE)||MANAGER_PANEL_MODULE,this._managerPanelPromise=require.async(e).bind(this).then(function(e){var i=new e.AuthorizationManagerPanel;return r.authorizationManagerPanel=i,i.authorizationManager=r,i})["catch"](function(e){console.log(e)})),this._managerPanelPromise}},_panelForProvider:{value:function(e){var r=this._panelModuleIDForProvider(e),i=this._panelsByModuleID.get(r);return i?Promise.resolve(i):this._makePanelForProvider(r,e)}},_panelModuleIDForProvider:{value:function(e){var r=e.authorizationPanel;return this.callDelegateMethod("authorizationManagerWillAuthorizeServiceWithPanelModuleId",this,e,r)||r}},_makePanelForProvider:{value:function(e,r){var i,t=this,a=Montage.getInfoForObject(r);return e&&(i=a.require.async(e).then(function(i){var a,o,n,u=Object.keys(i);for(o=0,n=u.length;o<n&&!a;++o)a=t._panelForConstructorAndProvider(i[u[o]],r);return a.service=r,t._panelsByModuleID.set(e,a),a})),i}},_panelForConstructorAndProvider:{value:function(e,r){return this.callDelegateMethod("authorizationManagerWillInstantiateAuthorizationPanelForService",this,e,r)||new e}},_canNotifyDataService:{value:function(e){return e.authorizationManagerWillAuthorizeWithService&&"function"==typeof e.authorizationManagerWillAuthorizeWithService}},_providersForDataService:{value:function(e){var r,i,t,a=[],o=Montage.getInfoForObject(e),n=e.authorizationServices;for(i=0,t=n.length;i<t;++i)r=this._providerWithModuleID(n[i],o.require),a.push(r);return Promise.all(a)}},_providerWithModuleID:{value:function(e,r){var i=this._providersByModuleID.get(e);return i?Promise.resolve(i):this._makeProviderWithModuleID(e,r)}},_authorizationWithProvider:{value:function(e,r){var i,t=this;return this._providerWithModuleID(e,r).then(function(e){return i=e,i.authorize()}).then(function(e){return e||t._authorizeProviderWithManagerPanel(i)})}},_authorizeProviderWithManagerPanel:{value:function(e){var r,i=this;return i._pendingServicesCount++,this._managerPanel().then(function(t){return r=t,i._panelForProvider(e)}).then(function(e){return r.authorizeWithPanel(e)}).then(function(e){return i._pendingServicesCount--,e})}},_makeProviderWithModuleID:{value:function(e,r){var i=this;return r.async(e).then(function(e){var r,t,a,o=Object.keys(e);for(t=0;a=o[t];++t)r=r||new e[a];return i.registerAuthorizationService(r),r})}},_notifyDataService:{value:function(e){var r,i;return this._canNotifyDataService(e)?this._providersForDataService(e).then(function(t){for(r=0,i=t.length;r<i;r++)e.authorizationManagerWillAuthorizeWithService(this,t[r])}):Promise.resolve(null)}},authorizationManagerPanel:{value:void 0},authorizeService:{value:function(e,r){var i=this,t=[];return e.authorizationPolicy===AuthorizationPolicy.NONE?Promise.resolve(null):(t=this._authorizationsForDataService(e),t.length?Promise.all(t):e.authorizationPolicy!==AuthorizationPolicy.ON_DEMAND||r?(t=this._authorizationsForDataService(e,!0),i._notifyDataService(e).then(function(){var e=application.applicationModal&&i.authorizationManagerPanel.runModal;return e?i.authorizationManagerPanel.runModal():Promise.all(t)}).then(function(r){return i.callDelegateMethod("authorizationManagerDidAuthorizeService",i,e),r})["catch"](function(){i.hasPendingServices=!1})):Promise.resolve(null))}},_authorizationsForDataService:{value:function(e,r){var i,t,a,o,n=[],u=Montage.getInfoForObject(e);for(a=0,o=e.authorizationServices.length;a<o;a++)t=e.authorizationServices[a],i=this._authorizationForServiceFromProvider(t,u.require,r),i&&n.push(i);return n}},_authorizationForServiceFromProvider:{value:function(e,r,i){var t=null;return this._authorizationsByProviderModuleID.has(e)?t=this._authorizationsByProviderModuleID.get(e):i&&(t=this._authorizationWithProvider(e,r),this._authorizationsByProviderModuleID.set(e,t)),t}},_pendingServicesCount:{value:0},delegate:{value:null},hasPendingServices:{value:!1},registerAuthorizationService:{value:function(e){var r=Montage.getInfoForObject(e);this._providersByModuleID.set(r.moduleId,e)}}});exports.AuthorizationManager=new AuthorizationManager;