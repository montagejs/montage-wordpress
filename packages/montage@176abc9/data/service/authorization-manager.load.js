montageDefine("176abc9","data/service/authorization-manager",{dependencies:["core/core","core/promise","collections/map","core/application","data/service/authorization-policy"],factory:function(e,r,i){var t=e("core/core").Montage,a=e("core/promise").Promise,o=e("collections/map"),n=e("core/application").application,u=e("data/service/authorization-policy").AuthorizationPolicy,l="ui/authorization-manager-panel.reel",h=t.specialize({constructor:{value:function(){return this._providersByModuleID=new o,this._panelsByModuleID=new o,this._authorizationsByProviderModuleID=new o,this.defineBinding("hasPendingServices",{"<-":"_pendingServicesCount != 0"}),this}},_authorizationsByProviderModuleID:{value:void 0},_panelsByModuleID:{value:void 0},_providersByModuleID:{value:void 0},_managerPanel:{value:function(){var r,i=this;return!this._managerPanelPromise&&this.authorizationManagerPanel?(this.authorizationManagerPanel.authorizationManager=this,this._managerPanelPromise=a.resolve(this.authorizationManagerPanel)):this._managerPanelPromise||(r=this.callDelegateMethod("authorizationManagerWillLoadAuthorizationManagerPanel",this,l)||l,this._managerPanelPromise=e.async(r).bind(this).then(function(e){var r=new e.AuthorizationManagerPanel;return i.authorizationManagerPanel=r,r.authorizationManager=i,r})["catch"](function(e){console.log(e)})),this._managerPanelPromise}},_panelForProvider:{value:function(e){var r=this._panelModuleIDForProvider(e),i=this._panelsByModuleID.get(r);return i?a.resolve(i):this._makePanelForProvider(r,e)}},_panelModuleIDForProvider:{value:function(e){var r=e.authorizationPanel;return this.callDelegateMethod("authorizationManagerWillAuthorizeServiceWithPanelModuleId",this,e,r)||r}},_makePanelForProvider:{value:function(e,r){var i,a=this,o=t.getInfoForObject(r);return e&&(i=o.require.async(e).then(function(i){var t,o,n,u=Object.keys(i);for(o=0,n=u.length;o<n&&!t;++o)t=a._panelForConstructorAndProvider(i[u[o]],r);return t.service=r,a._panelsByModuleID.set(e,t),t})),i}},_panelForConstructorAndProvider:{value:function(e,r){return this.callDelegateMethod("authorizationManagerWillInstantiateAuthorizationPanelForService",this,e,r)||new e}},_canNotifyDataService:{value:function(e){return e.authorizationManagerWillAuthorizeWithService&&"function"==typeof e.authorizationManagerWillAuthorizeWithService}},_providersForDataService:{value:function(e){var r,i,o,n=[],u=t.getInfoForObject(e),l=e.authorizationServices;for(i=0,o=l.length;i<o;++i)r=this._providerWithModuleID(l[i],u.require),n.push(r);return a.all(n)}},_providerWithModuleID:{value:function(e,r){var i=this._providersByModuleID.get(e);return i?a.resolve(i):this._makeProviderWithModuleID(e,r)}},_authorizationWithProvider:{value:function(e,r){var i,t=this;return this._providerWithModuleID(e,r).then(function(e){return i=e,i.authorize()}).then(function(e){return e||t._authorizeProviderWithManagerPanel(i)})}},_authorizeProviderWithManagerPanel:{value:function(e){var r,i=this;return i._pendingServicesCount++,this._managerPanel().then(function(t){return r=t,i._panelForProvider(e)}).then(function(e){return r.authorizeWithPanel(e)}).then(function(e){return i._pendingServicesCount--,e})}},_makeProviderWithModuleID:{value:function(e,r){var i=this;return r.async(e).then(function(e){var r,t,a,o=Object.keys(e);for(t=0;a=o[t];++t)r=r||new e[a];return i.registerAuthorizationService(r),r})}},_notifyDataService:{value:function(e){var r,i;return this._canNotifyDataService(e)?this._providersForDataService(e).then(function(t){for(r=0,i=t.length;r<i;r++)e.authorizationManagerWillAuthorizeWithService(this,t[r])}):a.resolve(null)}},authorizationManagerPanel:{value:void 0},authorizeService:{value:function(e,r){var i=this,t=[];return e.authorizationPolicy===u.NONE?a.resolve(null):(t=this._authorizationsForDataService(e),t.length?a.all(t):e.authorizationPolicy!==u.ON_DEMAND||r?(t=this._authorizationsForDataService(e,!0),i._notifyDataService(e).then(function(){var e=n.applicationModal&&i.authorizationManagerPanel.runModal;return e?i.authorizationManagerPanel.runModal():a.all(t)}).then(function(r){return i.callDelegateMethod("authorizationManagerDidAuthorizeService",i,e),r})["catch"](function(){i.hasPendingServices=!1})):a.resolve(null))}},_authorizationsForDataService:{value:function(e,r){var i,a,o,n,u=[],l=t.getInfoForObject(e);for(o=0,n=e.authorizationServices.length;o<n;o++)a=e.authorizationServices[o],i=this._authorizationForServiceFromProvider(a,l.require,r),i&&u.push(i);return u}},_authorizationForServiceFromProvider:{value:function(e,r,i){var t=null;return this._authorizationsByProviderModuleID.has(e)?t=this._authorizationsByProviderModuleID.get(e):i&&(t=this._authorizationWithProvider(e,r),this._authorizationsByProviderModuleID.set(e,t)),t}},_pendingServicesCount:{value:0},delegate:{value:null},hasPendingServices:{value:!1},registerAuthorizationService:{value:function(e){var r=t.getInfoForObject(e);this._providersByModuleID.set(r.moduleId,e)}}});r.AuthorizationManager=new h}});