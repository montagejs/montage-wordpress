var Montage=require("core/core").Montage,DataObjectDescriptor=require("data/model/data-object-descriptor").DataObjectDescriptor,ObjectDescriptor=require("data/model/object-descriptor").ObjectDescriptor,WeakMap=require("collections/weak-map"),DataTrigger;DataTrigger=exports.DataTrigger=function(){},exports.DataTrigger.prototype=Object.create({},{constructor:{configurable:!0,writable:!0,value:exports.DataTrigger},_service:{configurable:!0,writable:!0,value:void 0},_objectPrototype:{configurable:!0,writable:!0,value:void 0},_propertyName:{configurable:!0,writable:!0,value:void 0},_privatePropertyName:{configurable:!0,get:function(){return!this.__privatePropertyName&&this._propertyName&&(this.__privatePropertyName="_"+this._propertyName),this.__privatePropertyName}},_isGlobal:{configurable:!0,get:function(){return!(this._valueStatus instanceof WeakMap)},set:function(e){e=!!e,e!==this._isGlobal&&(this._valueStatus=e?void 0:new WeakMap)}},_valueStatus:{configurable:!0,writable:!0,value:void 0},_getValueStatus:{configurable:!0,value:function(e){return this._isGlobal?this._valueStatus:this._valueStatus.get(e)}},_setValueStatus:{configurable:!0,value:function(e,t){this._isGlobal?this._valueStatus=t:void 0!==t?this._valueStatus.set(e,t):this._valueStatus["delete"](e)}},_getValue:{configurable:!0,writable:!0,value:function(e){var t,r,a;for(this.getObjectProperty(e),t=Object.getPrototypeOf(this._objectPrototype);t;)r=Object.getOwnPropertyDescriptor(t,this._propertyName),a=r&&r.get,t=!a&&Object.getPrototypeOf(t);return a?a.call(e):e[this._privatePropertyName]}},_setValue:{configurable:!0,writable:!0,value:function(e,t){var r,a,i,o,s,n;for(r=this._getValueStatus(e),this._setValueStatus(e,null),a=Object.getPrototypeOf(this._objectPrototype);a;)i=Object.getOwnPropertyDescriptor(a,this._propertyName),o=i&&i.get,s=o&&i.set,n=!i||s||i.writable,a=n&&!s&&Object.getPrototypeOf(a);s?s.call(e,t):n&&(e[this._privatePropertyName]=t),r&&r.resolve(null)}},decacheObjectProperty:{value:function(e){this._setValueStatus(e,void 0)}},getObjectProperty:{value:function(e){var t=this._getValueStatus(e);return t?t.promise:null===t?this._service.nullPromise:this.updateObjectProperty(e)}},updateObjectProperty:{value:function(e){var t=this,r=this._getValueStatus(e)||{};return r.promise||(this._setValueStatus(e,r),r.promise=new Promise(function(a,i){r.resolve=a,r.reject=i,t._fetchObjectProperty(e)})),r.promise}},_fetchObjectProperty:{value:function(e){var t=this;this._service.fetchObjectProperty(e,this._propertyName).then(function(){return t._fulfillObjectPropertyFetch(e)})["catch"](function(r){return console.error(r),t._fulfillObjectPropertyFetch(e,r)})}},_fulfillObjectPropertyFetch:{value:function(e,t){var r=this._getValueStatus(e);return this._setValueStatus(e,null),r&&!t?r.resolve(null):r&&t&&(console.error(t),r.reject(t)),null}}}),Object.defineProperties(exports.DataTrigger,{addTriggers:{value:function(e,t,r,a){var i=t instanceof DataObjectDescriptor||t instanceof ObjectDescriptor;return i?this._addTriggersForMontageDataType(e,t,r,name):this._addTriggers(e,t,r,a)}},_addTriggersForMontageDataType:{value:function(e,t,r){var a,i,o,s={},n=Object.keys(t.propertyDescriptors);for(o=0;i=n[o];++o)a=this.addTrigger(e,t,r,i),a&&(s[i]=a);return s}},_addTriggers:{value:function(e,t,r,a){var i,o,s,n,u={},c=t.propertyDescriptors;for(n=0;i=c[n];n+=1)a.has(i.name)||(s=i.name,o=this.addTrigger(e,t,r,s),o&&(u[s]=o));return u}},addTrigger:{value:function(e,t,r,a){var i=t instanceof DataObjectDescriptor||t instanceof ObjectDescriptor;return i?this._addTriggerForMontageDataType(e,t,r,a):this._addTrigger(e,t,r,a)}},_addTriggerForMontageDataType:{value:function(e,t,r,a){var i,o=t.propertyDescriptors[a];return o&&o.isRelationship&&(i=Object.create(this._getTriggerPrototype(e)),i._objectPrototype=r,i._propertyName=a,i._isGlobal=o.isGlobal,Montage.defineProperty(r,a,{get:function(){return i._getValue(this)},set:function(e){i._setValue(this,e)}})),i}},_createTrigger:{value:function(e,t,r,a,i){var o=Object.create(this._getTriggerPrototype(e)),s=e._dataObjectTriggers.get(t);return o._objectPrototype=r,o._propertyName=a,o._isGlobal=i.isGlobal,s||(s={},e._dataObjectTriggers.set(t,s)),s[a]=o,o}},_addTrigger:{value:function(e,t,r,a){var i,o=t.propertyDescriptorForName(a);return o&&(i=Object.create(this._getTriggerPrototype(e)),i._objectPrototype=r,i._propertyName=a,i._isGlobal=o.isGlobal,o.definition?Montage.defineProperty(r,a,{get:function(){return this.getBinding(a)||this.defineBinding(a,{"<-":o.definition}),i._getValue(this)},set:function(e){i._setValue(this,e)}}):Montage.defineProperty(r,a,{get:function(){return i._getValue(this)},set:function(e){i._setValue(this,e)}}),i=Object.create(this._getTriggerPrototype(e)),i._objectPrototype=r,i._propertyName=a,i._isGlobal=o.isGlobal),i}},_getTriggerPrototype:{value:function(e){var t=this._triggerPrototypes&&this._triggerPrototypes.get(e);return t||(t=new this,t._service=e,this._triggerPrototypes=this._triggerPrototypes||new WeakMap,this._triggerPrototypes.set(e,t)),t}},removeTriggers:{value:function(e,t){var r,a,i=Object.keys(e);for(a=0;r=i[a];++a)this.removeTrigger(e[r],t,r)}},removeTrigger:{value:function(e,t){e&&delete t[e.name]}}});