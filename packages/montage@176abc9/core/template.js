function instantiateDocument(e,t,i){var n,r,a=new Template,s=e.documentElement.outerHTML,l=new DocumentPart,o=e.documentElement;return n=a.createHtmlDocumentWithHtml(s,e.location.href),a.initWithDocument(n,t).then(function(){return a.setBaseUrl(e.location.href),r=a._createTemplateObjects(i),l.initWithTemplateAndFragment(a),a._instantiateObjects(r,o).then(function(e){return l.objects=e,a._invokeDelegates(l),l})})}var Montage=require("./core").Montage,Deserializer=require("core/serialization/deserializer/montage-deserializer").MontageDeserializer,DocumentPart=require("./document-part").DocumentPart,DocumentResources=require("./document-resources").DocumentResources,Serialization=require("./serialization/serialization").Serialization,MontageLabeler=require("./serialization/serializer/montage-labeler").MontageLabeler,Promise=require("./promise").Promise,URL=require("./mini-url"),logger=require("./logger").logger("template"),defaultEventManager=require("./event/event-manager").defaultEventManager,defaultApplication,Template=Montage.specialize({_SERIALIZATION_SCRIPT_TYPE:{value:"text/montage-serialization"},_ELEMENT_ID_ATTRIBUTE:{value:"data-montage-id"},PARAM_ATTRIBUTE:{value:"data-param"},_require:{value:null},_resources:{value:null},_baseUrl:{value:null},_instances:{value:null},_metadata:{value:null},_objectsString:{value:null},objectsString:{get:function(){return this._objectsString},set:function(e){this._objectsString=e,this._serialization&&this._serialization.initWithString(e),this.__deserializer=null}},__deserializer:{value:null},_deserializer:{get:function(){var e,t,i=this.__deserializer;if(!i){if(e=this._metadata){t=Object.create(null);for(var n in e)t[n]=e[n].require}i=(new Deserializer).init(this.objectsString,this._require,t),this.__deserializer=i}return i}},getDeserializer:{value:function(){return this._deserializer}},_serialization:{value:null},getSerialization:{value:function(){var e=this._serialization;return e||(e=this._serialization=new Serialization,e.initWithString(this.objectsString)),e}},_isDirty:{value:!1},isDirty:{get:function(){return this._isDirty},set:function(e){this._isDirty!==e&&(this._isDirty=e,this.clearTemplateFromElementContentsCache())}},refresher:{value:null},_document:{value:null},document:{get:function(){return this._isDirty&&this.refresh(),this._document},set:function(e){this._document=e}},initWithRequire:{value:function(e){return this._require=e,this.document=this.createHtmlDocumentWithHtml(""),this.objectsString="",this}},initWithDocument:{value:function(e,t){var i=this;return this._require=t,this.setDocument(e),this.getObjectsString(e).then(function(e){return i.objectsString=e,i})}},initWithHtml:{value:function(e,t){var i=this;return this._require=t,this.document=this.createHtmlDocumentWithHtml(e),this.getObjectsString(this.document).then(function(e){return i.objectsString=e,i})}},initWithObjectsAndDocumentFragment:{value:function(e,t,i){return this._require=i,this.document=this.createHtmlDocumentWithHtml(""),this.document.body.appendChild(this.document.importNode(t,!0)),this.setObjects(e),this}},initWithModuleId:{value:function(e,t){var i=this;return this._require=t,this.createHtmlDocumentWithModuleId(e,t).then(function(n){var r=t(e).directory;return i.document=n,i.setBaseUrl(r),i.getObjectsString(n).then(function(e){return i.objectsString=e,i})})}},clone:{value:function(){var e=new Template;return e._require=this._require,e._baseUrl=this._baseUrl,e.setDocument(this.document),e.objectsString=this.objectsString,e._instances=Object.clone(this._instances,1),e}},instantiate:{value:function(e){return this.instantiateWithInstances(null,e)}},instantiateWithInstances:{value:function(e,t){var i,n,r,a=this,s=new DocumentPart;return e=e||this._instances,i=this._createMarkupDocumentFragment(t),r=this._getParameters(i),s.initWithTemplateAndFragment(this,i),s.startActingAsTopComponent(),s.parameters=r,n=this._createTemplateObjects(e),this._instantiateObjects(n,i).then(function(i){var n=a.getResources();return!n.resourcesLoaded()&&n.hasResources()&&n.loadResources(t),s.objects=i,a._invokeDelegates(s,e),s.stopActingAsTopComponent(),s})}},_objectsInstantiationOptimized:{value:!1},_optimizeObjectsInstantiationPromise:{value:null},_optimizeObjectsInstantiation:{value:function(){var e,t=this;if(!this._objectsInstantiationOptimized)return this._optimizeObjectsInstantiationPromise||(e=this._deserializer.preloadModules(),e?this._optimizeObjectsInstantiationPromise=e.then(function(){t._objectsInstantiationOptimized=!0}):this._objectsInstantiationOptimized=!0),this._optimizeObjectsInstantiationPromise}},setBaseUrl:{value:function(e){this._baseUrl=e}},getBaseUrl:{value:function(){return this._baseUrl}},getResources:{value:function(){var e=this._resources;return e||(e=this._resources=new exports.TemplateResources,e.initWithTemplate(this)),e}},_createTemplateObjects:{value:function(e){var t=Object.create(e||null);return"undefined"==typeof defaultApplication&&(defaultApplication=require("./application").application),t.application=defaultApplication,t.template=this,t}},_instantiateObjects:{value:function(e,t){var i,n=this._deserializer;return Promise.is(n)?n:(i=this._optimizeObjectsInstantiation(),i?i.then(function(){return n.deserialize(e,t)}):n.deserialize(e,t))}},_createMarkupDocumentFragment:{value:function(e){for(var t=e.createDocumentFragment(),i=this.document.body.childNodes,n=0,r=i.length;n<r;n++)t.appendChild(e.importNode(i[n],!0));return t}},getParameterName:{value:function(e){return e.getAttribute(this.PARAM_ATTRIBUTE)}},getParameters:{value:function(){return this._getParameters(this.document.body)}},_getParameters:{value:function(e){for(var t,i,n=e.querySelectorAll("*["+this.PARAM_ATTRIBUTE+"]"),r=n.length,a={},s=0;s<r;s++){if(t=n[s],i=this.getParameterName(t),i in a)throw new Error('The parameter "'+i+'" is declared more than once in '+this.getBaseUrl()+".");a[i]=t}return a}},hasParameters:{value:function(){return!!this.document.querySelector("*["+this.PARAM_ATTRIBUTE+"]")}},_invokeDelegates:{value:function(e,t){var i,n,r,a=e.objects,s=a.owner||t&&t.owner;for(var l in a)t&&l in t||(i=a[l],n=this._getObjectOwner(l,s),r=this._getObjectLabel(l),i&&("function"==typeof i._deserializedFromTemplate&&i._deserializedFromTemplate(n,r,e),"function"==typeof i.deserializedFromTemplate&&i.deserializedFromTemplate(n,r,e)));if(s){var o=this.getSerialization();o.isExternalObject("owner")||("function"==typeof s._templateDidLoad&&s._templateDidLoad(e),"function"==typeof s.templateDidLoad&&s.templateDidLoad(e))}}},setInstances:{value:function(e){this._instances=e}},getInstances:{value:function(){return this._instances}},setObjects:{value:function(e){this.objectsString=JSON.stringify(e,null,4)}},setObjectMetadata:{value:function(e,t,i,n){var r=this._metadata;r||(this._metadata=r=Object.create(null)),r[e]={require:t,label:i,owner:n},this.__deserializer=null}},getObjectMetadata:{value:function(e){var t=this._metadata;return t&&e in t?t[e]:{require:this._require,label:e}}},_getObjectOwner:{value:function(e,t){var i,n=this._metadata;return i=n&&e in n?n[e].owner:t}},_getObjectLabel:{value:function(e){var t,i=this._metadata;return t=i&&e in i?i[e].label:e}},setDocument:{value:function(e){this.document=this.cloneHtmlDocument(e),this.clearTemplateFromElementContentsCache()}},getObjectsString:{value:function(e){var t;return t=this.getInlineObjectsString(e),null===t?this.getExternalObjectsString(e):Promise.resolve(t)}},getInlineObjectsString:{value:function(e){var t="script[type='"+this._SERIALIZATION_SCRIPT_TYPE+"']",i=e.querySelector(t);return i?i.textContent:null}},getExternalObjectsString:{value:function(e){var t,i=e.querySelector('link[rel="serialization"]');return i?t=new Promise(function(e,t){var n=new XMLHttpRequest,r=i.getAttribute("href");n.open("GET",r),n.addEventListener("load",function(i){var n=i.target;200===n.status?e(n.responseText):t(new Error("Unable to retrive '"+r+"', code status: "+n.status))},!1),n.addEventListener("error",function(e){t(new Error("Unable to retrive '"+r+"' with error: "+e.error+"."))},!1),n.send()}):Promise.resolve(null)}},createHtmlDocumentWithHtml:{value:function(e,t){var i=document.implementation.createHTMLDocument("");return e&&(i.documentElement.innerHTML=e,t&&this.normalizeRelativeUrls(i,t)),i}},cloneHtmlDocument:{value:function(e){var t=document.implementation.createHTMLDocument(""),i=e.baseURI||e.URL;return t.replaceChild(t.importNode(e.documentElement,!0),t.documentElement),this.normalizeRelativeUrls(t,i),t}},createHtmlDocumentWithModuleId:{value:function(e,t){var i=this;return"function"!=typeof t?Promise.reject(new Error("Missing 'require' function to load module '"+e+"'.")):t.async(e).then(function(e){return i.createHtmlDocumentWithHtml(e.content,e.directory)})}},_removeObjects:{value:function(e){var t="script[type='"+this._SERIALIZATION_SCRIPT_TYPE+"'], link[rel='serialization']";Array.prototype.forEach.call(e.querySelectorAll(t),function(e){e.parentNode.removeChild(e)})}},_addObjects:{value:function(e,t){if(t){var i=e.createElement("script");i.setAttribute("type",this._SERIALIZATION_SCRIPT_TYPE),i.textContent=JSON.stringify(JSON.parse(t),null,4),e.head.appendChild(i)}}},_templateFromElementContentsCache:{value:null},clearTemplateFromElementContentsCache:{value:function(){this._templateFromElementContentsCache=null}},createTemplateFromElementContents:{value:function(e){var t,i,n,r=this._templateFromElementContentsCache;return r||(r=Object.create(null),this._templateFromElementContentsCache=r),e in r?Object.create(r[e]):(t=this.getElementById(e),n=this.document.createRange(),n.selectNodeContents(t),i=this.createTemplateFromRange(n),r[e]=i,Object.create(i))}},createTemplateFromElement:{value:function(e){var t,i;return t=this.getElementById(e),i=this.document.createRange(),i.selectNode(t),this.createTemplateFromRange(i)}},createTemplateFromRange:{value:function(e){var t,i,n,r,a,s=new Serialization;return t=e.cloneContents(),i=this._getChildrenElementIds(t),s.initWithString(this.objectsString),n=s.getSerializationLabelsWithElements(i),a=s.extractSerialization(n,["owner"]),r=new Template,r.initWithObjectsAndDocumentFragment(null,t,this._require),r.objectsString=a.getSerializationString(),r._resources=this.getResources(),r}},_createSerializationWithElementIds:{value:function(e){var t,i,n=new Serialization;return n.initWithString(this.objectsString),t=n.getSerializationLabelsWithElements(e),i=n.extractSerialization(t,["owner"])}},expandParameters:{value:function(e){var t,i,n,r,a,s,l,o=[],u={},c=this.getSerialization(),m={};t=this.getParameters();for(var h in t)if(t.hasOwnProperty(h)){if(r=t[h],a=e.getTemplateArgumentElement(h),"*"===h&&r.childElementCount>0){if(!(a.childElementCount>0||a.firstChild&&a.firstChild.data&&a.firstChild.data.trim())){var d=r.ownerDocument.createRange();d.selectNodeContents(r),this.replaceNode(d.extractContents(),r);break}c.getSerializationLabels();c.removeObjectsWithLabels(this._getChildrenElementIds(r))}if(o.push.apply(o,this._getElementIds(a)),i=this.replaceNode(a,r))for(var _ in i)u[_]=i[_]}return m.elementIds=o,m.elementIdsCollisions=u,s=e.getTemplateArgumentSerialization(o),s.renameElementReferences(u),l=function(t){if(t.indexOf(":")>0)return e.resolveTemplateArgumentTemplateProperty(t)},n=c.mergeSerialization(s,{willMergeObjectWithLabel:l}),this.objectsString=c.getSerializationString(),m.labels=s.getSerializationLabels(),m.labelsCollisions=n,m}},_resolveElementIdCollisions:{value:function(e,t){var i,n,r,a,s,l;t=t||new MontageLabeler,a=this.getElementIds();for(var o=0;r=a[o];o++)t.addLabel(r);n=this._getElements(e);for(r in n)this.getElementById(r)&&(s=n[r],l=t.generateLabel(t.getLabelBaseName(r)),this.setElementId(s,l),i||(i=Object.create(null)),i[r]=l);return i}},replaceNode:{value:function(e,t,i){var n;return n=this._resolveElementIdCollisions(e,i),this.normalizeRelativeUrls(e,this.getBaseUrl()),t.parentNode.replaceChild(e,t),n}},insertNodeBefore:{value:function(e,t,i){var n;return n=this._resolveElementIdCollisions(e,i),this.normalizeRelativeUrls(e,this.getBaseUrl()),t.parentNode.insertBefore(e,t),n}},appendNode:{value:function(e,t,i){var n;return n=this._resolveElementIdCollisions(e,i),this.normalizeRelativeUrls(e,this.getBaseUrl()),t.appendChild(e),n}},getElementId:{value:function(e){if(e.getAttribute)return e.getAttribute(this._ELEMENT_ID_ATTRIBUTE)}},setElementId:{value:function(e,t){e.setAttribute(this._ELEMENT_ID_ATTRIBUTE,t)}},getElementIds:{value:function(){return this._getElementIds(this.document.body)}},_getElements:{value:function(e){var t,i,n="*["+this._ELEMENT_ID_ATTRIBUTE+"]",r={};t=e.querySelectorAll(n);for(var a,s=0;a=t[s];s++)i=this.getElementId(a),r[i]=a;return i=this.getElementId(e),i&&(r[i]=e),r}},_getChildrenElementIds:{value:function(e){var t,i="*["+this._ELEMENT_ID_ATTRIBUTE+"]",n=[];t=e.querySelectorAll(i);for(var r,a=0;r=t[a];a++)n.push(this.getElementId(r));return n}},_getElementIds:{value:function(e){var t,i=this._getChildrenElementIds(e);return t=this.getElementId(e),t&&i.push(t),i}},getElementById:{value:function(e){var t="*["+this._ELEMENT_ID_ATTRIBUTE+"='"+e+"']";return this.document.querySelector(t)}},html:{get:function(){var e=this.document;return this._removeObjects(e),this._addObjects(e,this.objectsString),this._getDoctypeString(e.doctype)+"\n"+e.documentElement.outerHTML}},_getDoctypeString:{value:function(e){return"<!DOCTYPE "+e.name+(e.publicId?' PUBLIC "'+e.publicId+'"':"")+(!e.publicId&&e.systemId?" SYSTEM":"")+(e.systemId?' "'+e.systemId+'"':"")+">"}},normalizeRelativeUrls:{value:function(e,t){if("string"==typeof t&&""!==t&&"about:blank"!==t)for(var i="http://www.w3.org/1999/xlink",n=/^[\w\-]+:|^\//,r=Template._NORMALIZED_TAG_NAMES.indexOf(e.tagName)!==-1?[e]:e.querySelectorAll(Template._NORMALIZED_TAG_NAMES_SELECTOR),a=0,s=r.length;a<s;a++){var l,o=r[a];"image"===o.tagName?(l=o.getAttributeNS(i,"href"),n.test(l)||o.setAttributeNS(i,"href",URL.resolve(t,l))):o.hasAttribute("src")?(l=o.getAttribute("src"),""===l||n.test(l)||o.setAttribute("src",URL.resolve(t,l))):o.hasAttribute("href")&&(l=o.getAttribute("href"),""===l||n.test(l)||o.setAttribute("href",URL.resolve(t,l)))}}},replaceContentsWithTemplate:{value:function(e){this._require=e._require,this._baseUrl=e._baseUrl,this._document=e._document,this.objectsString=e.objectsString,this._instances=e._instances,this._templateFromElementContentsCache=e._templateFromElementContentsCache,this._metadata=e._metadata}},refresh:{value:function(){this.isDirty&&(this.refresher&&"function"==typeof this.refresher.refreshTemplate?(this.refresher.refreshTemplate(this),this.isDirty=!1):console.warn("Not able to refresh without a refresher.refreshTemplate."))}}},{_templateCache:{value:{moduleId:Object.create(null)}},_getTemplateCacheKey:{value:function(e,t){return e=t.resolve(e),t.location+"#"+e}},getTemplateWithModuleId:{value:function(e,t){var i,n;return i=this._getTemplateCacheKey(e,t),n=this._templateCache.moduleId[i],n||(n=(new Template).initWithModuleId(e,t),this._templateCache.moduleId[i]=n),n}},_NORMALIZED_TAG_NAMES:{value:["IMG","image","IFRAME","link","script"]},__NORMALIZED_TAG_NAMES_SELECTOR:{value:null},_NORMALIZED_TAG_NAMES_SELECTOR:{get:function(){return this.__NORMALIZED_TAG_NAMES_SELECTOR||(this.__NORMALIZED_TAG_NAMES_SELECTOR=this._NORMALIZED_TAG_NAMES.join(",")),this.__NORMALIZED_TAG_NAMES_SELECTOR}}}),TemplateResources=Montage.specialize({_resources:{value:null},_resourcesLoaded:{value:!1},template:{value:null},rootUrl:{value:""},constructor:{value:function(){this._resources=Object.create(null)}},initWithTemplate:{value:function(e){this.template=e}},hasResources:{value:function(){return this.getStyles().length>0||this.getScripts().length>0}},resourcesLoaded:{value:function(){return this._resourcesLoaded}},loadResources:{value:function(e){return this._resourcesLoaded=!0,Promise.all([this.loadScripts(e),this.loadStyles(e)])}},getScripts:{value:function(){var e,t,i,n=this._resources.scripts;if(!n){t=this.template,n=this._resources.scripts=[],i=t.document.querySelectorAll("script");for(var r=0,a=i.length;r<a;r++)e=i[r],e.type!==this.template._SERIALIZATION_SCRIPT_TYPE&&n.push(e)}return n}},loadScripts:{value:function(e){var t=this.getScripts(),i=t.length;if(i){for(var n=[],r=0;r<i;r++)n.push(this.loadScript(t[r],e));return Promise.all(n)}return Promise.resolve()}},loadScript:{value:function(e,t){var i,n;return i=DocumentResources.getInstanceForDocument(t),n=this._cloneScriptElement(e,t),i.addScript(n)}},_cloneScriptElement:{value:function(e,t){for(var i,n=t.createElement("script"),r=e.attributes,a=0,s=r.length;a<s;a++)i=r[a],n.setAttribute(i.name,i.value);return n.textContent=e.textContent,n}},getStyles:{value:function(){var e,t,i,n=this._resources.styles;return n||(i='link[rel="stylesheet"], style',e=this.template,t=e.document.querySelectorAll(i),n=Array.prototype.slice.call(t,0),this._resources.styles=n),n}},loadStyles:{value:function(e){var t,i=[];t=this.getStyles();for(var n=0,r=t.length;n<r;n++)i.push(this.loadStyle(t[n],e));return Promise.all(i)}},loadStyle:{value:function(e,t){var i,n;return i=e.getAttribute("href"),i?(n=DocumentResources.getInstanceForDocument(t),n.preloadResource(i)):Promise.resolve()}},createStylesForDocument:{value:function(e){for(var t,i,n=this.getStyles(),r=[],a=0;i=n[a];a++)t=e.importNode(i,!0),r.push(t);return r}}}),TemplateArgumentProvider=Montage.specialize({getTemplateArgumentElement:{value:Function.noop},getTemplateArgumentSerialization:{value:Function.noop},resolveTemplateArgumentTemplateProperty:{value:Function.noop}});exports.Template=Template,exports.TemplateArgumentProvider=TemplateArgumentProvider,exports.TemplateResources=TemplateResources,exports.instantiateDocument=instantiateDocument;