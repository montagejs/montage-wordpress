montageDefine("176abc9","core/serialization/deserializer/montage-deserializer",{dependencies:["../../core","./montage-interpreter","./montage-reviver","collections/map","core/promise","../../deprecate"],factory:function(e,t,i){var r=e("../../core").Montage,n=e("./montage-interpreter").MontageContext,o=e("./montage-reviver").MontageReviver,a=e("collections/map").Map,l=e("core/promise").Promise,s=e("../../deprecate"),c=t.MontageDeserializer=r.specialize({_serializationString:{value:null},_serialization:{value:null},serialization:{value:{get:function(){return this._serialization}}},init:{value:function(e,t,i,r){return"string"==typeof e?this._serializationString=e:this._serializationString=JSON.stringify(e),this._require=t,this._locationId=r,this._reviver=(new o).init(t,i,this.constructor),this}},deserialize:{value:function(e,t){var i=this._locationId&&c.moduleContexts.get(this._locationId);if(i)return i._objects.root?l.resolve(i._objects):l.reject(new Error('Unable to deserialize because a circular dependency was detected. Module "'+this._locationId+'" has already been loaded but its root could not be resolved.'));try{var r=JSON.parse(this._serializationString);return i=(new n).init(r,this._reviver,e,t,this._require),this._locationId&&c.moduleContexts.set(this._locationId,i),i.getObjects()}catch(o){return this._formatSerializationSyntaxError(this._serializationString)}}},deserializeObject:{value:function(e){return this.deserialize(e).then(function(e){return e.root})}},preloadModules:{value:function(){var e,t,i,r,n,a,s,c,u=JSON.parse(this._serializationString),d=this._reviver,h=d.moduleLoader;if(null!==u)for(t=Object.keys(u),e=0;i=t[e];++e)if(r=u[i],n=r.prototype||r.object){if("string"!=typeof n)throw new Error("Property 'object' of the object with the label '"+i+"' must be a module id");a=o.parseObjectLocationId(n),s=h.getModule(a.moduleId,i),l.is(s)&&(c||(c=[])).push(s)}if(c)return l.all(c)}},getExternalObjectLabels:{value:function(){var e=this._serialization,t=[];for(var i in e)0===Object.keys(e[i]).length&&t.push(i);return t}},_formatSerializationSyntaxError:{value:function(t){var i,r,n,o,a,l="   ",s=this._origin;return e.async("core/jshint").then(function(e){if(e.JSHINT(t))i="Syntax error in the serialization but not able to find it!\n"+t;else{r=e.JSHINT.errors[0],n=t.split("\n"),o=(l+n.length).length,a=r.line-1;for(var c=0,u=n.length;c<u;c++)n[c]=new Array(o-(c+1+"").length+1).join(c===a?">":" ")+(c+1)+" "+n[c];i="Syntax error at line "+r.line+(s?" from "+s:"")+":\n"+r.evidence+"\n"+r.reason+"\n"+n.join("\n")}throw new Error(i)})}},initWithObject:{value:s.deprecateMethod(void 0,function(e,t,i,r,n){return this.init(e,t,i,r,n)},"initWithObject","init")},initWithObjectAndRequire:{value:s.deprecateMethod(void 0,function(e,t,i){return this.init(e,t,i)},"initWithObjectAndRequire","init")}},{getModuleRequire:{value:function(e,t){for(var i=e.resolve(t),r=e.getModuleDescriptor(i);r.redirect||r.mappingRedirect;)r.redirect?i=r.redirect:(e=r.mappingRequire,i=r.mappingRedirect),r=e.getModuleDescriptor(i);return r.require}},_cache:{value:null},moduleContexts:{get:function(){return this._cache||(this._cache=new a),this._cache}}});c.defineDeserializationUnit=function(e,t){o.defineUnitReviver(e,t)},t.deserialize=function(e,t){return(new c).init(e,t).deserializeObject()}}});