var Montage=require("../../core").Montage,MontageReviver=require("./montage-reviver").MontageReviver,Promise=require("../../promise").Promise,deprecate=require("../../deprecate"),ONE_ASSIGNMENT="=",ONE_WAY="<-",TWO_WAY="<->",MontageInterpreter=Montage.specialize({_require:{value:null},_reviver:{value:null},init:{value:function(e,t){if(deprecate.deprecationWarningOnce("MontageInterpreter","MontageDeserializer"),"function"!=typeof e)throw new Error("Function 'require' missing.");return this._reviver=t,this._require=e,this}},instantiate:{value:function(e,t,i){var r;return r=(new exports.MontageContext).init(e,this._reviver,t,i,this._require),r.getObjects()}},preloadModules:{value:function(e){var t,i,r,n,s=this._reviver,o=s.moduleLoader,a=[];for(var u in e)if(e.hasOwnProperty(u)&&(t=e[u],i=t.prototype||t.object)){if("string"!=typeof i)throw new Error("Property 'object' of the object with the label '"+u+"' must be a module id");r=MontageReviver.parseObjectLocationId(i),n=o.getModule(r.moduleId,u),Promise.is(n)&&a.push(n)}if(a.length>0)return Promise.all(a)}}}),MontageContext=Montage.specialize({_ELEMENT_ID_ATTRIBUTE:{value:"data-montage-id"},_unitsToDeserialize:{value:null},_element:{value:null},_require:{value:null},_objects:{value:null},_userObjects:{value:null},_serialization:{value:null},_reviver:{value:null},_bindingsToDeserialize:{value:null},constructor:{value:function(){this._unitsToDeserialize=[]}},init:{value:function(e,t,i,r,n){if(this._reviver=t,this._serialization=e,this._objects=Object.create(null),i){this._userObjects=Object.create(null);for(var s in i)this._userObjects[s]=i[s]}return this._element=r,this._require=n,this}},setObjectLabel:{value:function(e,t){this._objects[t]=e}},getObject:{value:function(e){var t,i=this._serialization,r=this._reviver,n=this._objects;return e in n?n[e]:e in i?(t=r.reviveRootObject(i[e],this,e),e in n||(n[e]=t),t):Promise.reject(new Error("Object with label '"+e+"' was not found."))}},getObjects:{value:function(){var e,t=this,i=this._serialization,r=[];for(var n in i)i.hasOwnProperty(n)&&(e=this.getObject(n),Promise.is(e)&&r.push(e));return 0===r.length?Promise.resolve(this._invokeDidReviveObjects()):Promise.all(r).then(function(){return t._invokeDidReviveObjects()})}},hasUserObject:{value:function(e){var t=this._userObjects;return!!t&&e in t}},getUserObject:{value:function(e){var t=this._userObjects;if(t)return t[e]}},_invokeDidReviveObjects:{value:function(){var e,t=this,i=this._reviver;return"function"==typeof i.didReviveObjects&&(e=i.didReviveObjects(this._objects,this),Promise.is(e))?e.then(function(){return t._objects}):this._objects}},hasObject:{value:function(e){return e in this._serialization}},getRequire:{value:function(){return this._require}},getElement:{value:function(){return this._element}},getElementById:{value:function(e){var t="*["+this._ELEMENT_ID_ATTRIBUTE+'="'+e+'"]';return this._element.querySelector(t)}},_extractBindingsToDeserialize:{value:function(e,t){var i;for(var r in e)e.hasOwnProperty(r)&&(i=e[r],("object"==typeof i&&i&&1===Object.keys(i).length&&(ONE_WAY in i||TWO_WAY in i||ONE_ASSIGNMENT in i)||r.indexOf(".")>-1)&&(t[r]=i,delete e[r]));return t}},getBindingsToDeserialize:{value:function(){return this._bindingsToDeserialize}},setBindingsToDeserialize:{value:function(e,t){var i=Object.create(null);t.values?this._extractBindingsToDeserialize(t.values,i):t.properties&&this._extractBindingsToDeserialize(t.properties,i),Object.keys(i).length>0&&(this._bindingsToDeserialize||(this._bindingsToDeserialize=[]),this._bindingsToDeserialize.push({object:e,bindings:i}))}},setUnitsToDeserialize:{value:function(e,t,i){this._unitsToDeserialize.push({object:e,objectDesc:t,unitNames:i})}},getUnitsToDeserialize:{value:function(){return this._unitsToDeserialize}}});exports.MontageInterpreter=MontageInterpreter,exports.MontageContext=MontageContext;